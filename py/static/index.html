<!DOCTYPE html>
<html>
<head>
    <title>API Test</title>
</head>
<body>
    <h1>Dynamical System API Test</h1>
    <button onclick="testAPI()">Test API</button>
    <pre id="output"></pre>

    <script>
        class DynamicalSystemAPI {
            constructor(baseURL = 'http://localhost:5000') {
                this.baseURL = baseURL;
                this.state = null;
            }

            async initialize(config) {
                const response = await fetch(`${this.baseURL}/api/compute/initial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        center: config.center || [0, 0],
                        x_func: config.xFunc || 'y',
                        y_func: config.yFunc || '1 - a*x**2 + b*y',
                        constants: config.constants || { a: 1.4, b: 0.3 },
                        epsilon: config.epsilon || 0.01,
                        density: config.density || 100
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    this.state = {
                        points: data.points,
                        normals: data.normals,
                        step: data.step,
                        config: data.config,
                        xFunc: config.xFunc,
                        yFunc: config.yFunc,
                        constants: config.constants
                    };
                }
                return data;
            }

            async step() {
                if (!this.state) throw new Error('Not initialized');
                
                const response = await fetch(`${this.baseURL}/api/compute/step`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        points: this.state.points,
                        normals: this.state.normals,
                        x_func: this.state.xFunc,
                        y_func: this.state.yFunc,
                        constants: this.state.constants,
                        epsilon: this.state.config.epsilon,
                        density: this.state.config.density,
                        current_step: this.state.step
                    })
                });
                
                const data = await response.json();
                if (data.success && !data.diverged) {
                    this.state.points = data.points;
                    this.state.normals = data.normals;
                    this.state.step = data.step;
                }
                return data;
            }
        }

        async function testAPI() {
            const output = document.getElementById('output');
            output.textContent = 'Testing API...\n';
            
            try {
                const api = new DynamicalSystemAPI();
                output.textContent += 'Initializing...\n';
                const init = await api.initialize({
                    center: [0, 0],
                    xFunc: 'y',
                    yFunc: '1 - a*x**2 + b*y',
                    constants: { a: 1.4, b: 0.3 },
                    epsilon: 0.01,
                    density: 50
                });
                output.textContent += `Initial state: ${init.points.length} points\n`;
                
                for (let i = 0; i < 5; i++) {
                    const result = await api.step();
                    output.textContent += `Step ${result.step}: ${result.points.length} points\n`;
                }
                
                output.textContent +='\nAPI test successful!';
            } catch (error) {
                output.textContent +=`\nError: ${error.message}`;
            }
        }
    </script>
</body>
</html>